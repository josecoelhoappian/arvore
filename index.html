<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Árvore Genealógica</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
            touch-action: manipulation;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 10px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .search-section {
            margin-bottom: 12px;
            background-color: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
            flex-shrink: 0;
        }

        .search-box {
            display: flex;
            gap: 10px;
            position: relative;
        }

        .search-box input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            -webkit-appearance: none;
            appearance: none;
            font-size: 16px; /* Prevents zoom on iOS */
        }

        .search-button {
            padding: 12px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 50px;
        }

        .search-button:hover,
        .search-button:active {
            background-color: #2980b9;
        }

        .clear-search {
            position: absolute;
            right: 60px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            display: none;
        }

        .clear-search.active {
            display: block;
        }

        .main-content-wrapper {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .sidebar {
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 250px;
        }

        .main-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .content-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            background-color: #f9f9f9;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            font-size: 0.9rem;
            font-weight: bold;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border-bottom: 3px solid transparent;
            touch-action: manipulation;
        }

        .tab-btn:hover {
            background-color: #f1f1f1;
            color: #2c3e50;
        }

        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background-color: white;
        }

        .tab-btn .tab-icon {
            font-size: 0.9rem;
        }

        .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .tab-pane {
            flex: 1;
            display: none;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            padding: 12px;
        }

        .tab-pane.active {
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        .tree-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .details-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .section-title {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .section-title i {
            color: #3498db;
        }

        .person-list {
            list-style: none;
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
        }

        .person-item {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 6px;
            background-color: white;
            position: relative;
            font-size: 0.85rem;
            touch-action: manipulation;
        }

        .person-item:active {
            background-color: #f0f0f0;
            transform: scale(0.98);
        }

        .person-item:hover {
            background-color: #f9f9f9;
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
        }

        .person-item.active {
            background-color: #e8f4fc;
            border: 2px solid #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }

        .person-item.active::before {
            content: "✓";
            position: absolute;
            top: 8px;
            right: 8px;
            color: #3498db;
            font-weight: bold;
            font-size: 1rem;
        }

        .person-name-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }

        .person-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.95rem;
            flex: 1;
            position: relative;
        }

        .person-name.has-tooltip:hover::after,
        .person-surname.has-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 5px;
            pointer-events: none;
        }

        .person-gender {
            font-size: 1rem;
            color: #3498db;
            flex-shrink: 0;
        }

        .person-details {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-top: 8px;
        }

        .person-surname {
            font-size: 0.8rem;
            color: #7f8c8d;
            font-style: italic;
            position: relative;
            margin-bottom: 1px;
        }

        .person-meta {
            font-size: 0.75rem;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1px;
        }

        .person-birth {
            color: #27ae60;
        }

        .person-id {
            color: #95a5a6;
            font-family: monospace;
            font-size: 0.7rem;
        }

        .tree-container-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .tree-container {
            flex: 1;
            width: 100%;
            border: 1px solid #eee;
            border-radius: 4px;
            overflow: auto;
            position: relative;
            background-color: #f9f9f9;
            min-height: 250px;
            -webkit-overflow-scrolling: touch;
        }

        .tree-node {
            position: absolute;
            background-color: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            text-align: center;
            width: 120px;
            height: 70px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1;
            padding: 6px;
            font-size: 0.75rem;
            overflow: hidden;
            touch-action: manipulation;
        }

        .tree-node:active {
            transform: scale(0.95);
        }

        .tree-node:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            z-index: 2;
        }

        .tree-node.male {
            border-color: #3498db;
            background: linear-gradient(135deg, #e8f4fc 0%, #d4e8f7 100%);
        }

        .tree-node.female {
            border-color: #e84393;
            background: linear-gradient(135deg, #fce8f1 0%, #f8d4e4 100%);
        }

        .tree-node.unknown {
            border-color: #7f8c8d;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
        }

        .tree-node.selected {
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.5), 0 6px 20px rgba(52, 152, 219, 0.3);
            z-index: 3;
            border-width: 4px;
        }

        .node-name {
            font-weight: bold;
            margin-bottom: 2px;
            color: #2c3e50;
            font-size: 0.8rem;
            line-height: 1.1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
        }

        .node-name.has-tooltip,
        .node-surname.has-tooltip {
            position: relative;
        }

        .node-name.has-tooltip:hover::after,
        .node-surname.has-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 5px;
            min-width: 120px;
            max-width: 200px;
            text-align: center;
        }

        .node-surname {
            font-size: 0.65rem;
            color: #7f8c8d;
            margin-bottom: 3px;
            font-style: italic;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
        }

        .node-details {
            font-size: 0.6rem;
            color: #666;
            margin-bottom: 3px;
            line-height: 1;
        }

        .node-relationship {
            font-size: 0.55rem;
            color: #3498db;
            font-weight: bold;
            margin-top: 2px;
            padding: 1px 4px;
            background-color: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.2;
        }

        .tree-line {
            position: absolute;
            background-color: #7f8c8d;
            z-index: 0;
        }

        .details-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .details-content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .relationship-badge {
            display: inline-block;
            padding: 4px 10px;
            background-color: #3498db;
            color: white;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            font-size: 0.85rem;
        }

        .detail-item {
            margin-bottom: 12px;
        }

        .detail-label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .detail-label i {
            color: #3498db;
            width: 16px;
            font-size: 0.8rem;
        }

        .detail-value {
            color: #555;
            line-height: 1.4;
            padding-left: 22px;
            font-size: 0.85rem;
        }

        .relationship-list {
            list-style: none;
            padding: 0;
        }

        .relationship-item {
            padding: 8px;
            background-color: white;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 0.8rem;
            touch-action: manipulation;
        }

        .relationship-item:active {
            background-color: #f0f0f0;
            transform: scale(0.98);
        }

        .relationship-item:hover {
            background-color: #f9f9f9;
            border-color: #3498db;
        }

        .relationship-info {
            flex: 1;
        }

        .relationship-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.85rem;
        }

        .relationship-type {
            color: #3498db;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .relationship-id {
            color: #95a5a6;
            font-family: monospace;
            font-size: 0.65rem;
        }

        .empty-message {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-size: 0.95rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .empty-message i {
            font-size: 2.25rem;
            color: #bdc3c7;
        }

        footer {
            text-align: center;
            margin-top: 12px;
            padding: 12px;
            color: #7f8c8d;
            font-size: 0.75rem;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Search results dropdown */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
            margin-top: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            touch-action: manipulation;
        }

        .search-result-item:active {
            background-color: #f0f0f0;
        }

        .search-result-item:hover {
            background-color: #f9f9f9;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 3px;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-surname {
            font-size: 0.8rem;
            color: #7f8c8d;
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-details {
            font-size: 0.75rem;
            color: #7f8c8d;
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-end;
            text-align: right;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .search-result-id {
            font-family: monospace;
            color: #95a5a6;
            font-size: 0.7rem;
        }

        .search-result-birth {
            color: #27ae60;
        }

        .search-count {
            padding: 8px 12px;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
            font-size: 0.8rem;
            color: #7f8c8d;
            text-align: center;
        }

        /* Custom scrollbars */
        .person-list::-webkit-scrollbar,
        .tree-container::-webkit-scrollbar,
        .details-content-wrapper::-webkit-scrollbar,
        .search-results::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .person-list::-webkit-scrollbar-track,
        .tree-container::-webkit-scrollbar-track,
        .details-content-wrapper::-webkit-scrollbar-track,
        .search-results::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .person-list::-webkit-scrollbar-thumb,
        .tree-container::-webkit-scrollbar-thumb,
        .details-content-wrapper::-webkit-scrollbar-thumb,
        .search-results::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .person-list::-webkit-scrollbar-thumb:hover,
        .tree-container::-webkit-scrollbar-thumb:hover,
        .details-content-wrapper::-webkit-scrollbar-thumb:hover,
        .search-results::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Mobile optimizations */
        @media (min-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .main-content-wrapper {
                flex-direction: row;
                gap: 15px;
            }
            
            .sidebar {
                flex: 0 0 280px;
                height: auto;
                max-height: none;
            }
            
            .search-box {
                flex-direction: row;
            }
            
            .search-result-item {
                flex-direction: row;
            }
            
            .search-result-details {
                flex-direction: row;
                gap: 12px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .tab-btn {
                padding: 12px;
                font-size: 0.95rem;
            }
            
            .tab-btn .tab-icon {
                font-size: 1rem;
            }
            
            .tree-node {
                width: 130px;
                height: 75px;
                font-size: 0.75rem;
            }
            
            .node-name {
                font-size: 0.8rem;
            }
            
            .node-surname {
                font-size: 0.65rem;
            }
        }

        @media (min-width: 1200px) {
            .details-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        /* Improve touch targets */
        @media (max-width: 767px) {
            .person-item,
            .relationship-item,
            .search-result-item,
            .tree-node {
                min-height: 44px; /* Minimum touch target size */
            }
            
            button,
            .tab-btn {
                min-height: 44px;
            }
            
            input {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .tree-container {
                min-height: 300px;
            }
            
            .search-box {
                position: relative;
            }
            
            .search-button {
                position: absolute;
                right: 0;
                top: 0;
                height: 100%;
                width: 50px;
            }
            
            .clear-search {
                right: 55px;
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .no-results {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .highlight {
            background-color: #fffacd;
            padding: 0 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tree"></i> Árvore Genealógica</h1>
            <p class="subtitle">Visualize toda a árvore genealógica com ancestrais e descendentes</p>
        </header>

        <div class="search-section">
            <h2 class="section-title"><i class="fas fa-search"></i> Procurar Pessoa</h2>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Digite o nome, sobrenome ou ID..." autocomplete="off">
                <button class="clear-search" id="clear-search"><i class="fas fa-times"></i></button>
                <button class="search-button" id="search-button"><i class="fas fa-search"></i></button>
            </div>
            <div class="search-results" id="search-results">
                <!-- Search results will appear here -->
            </div>
        </div>

        <div class="main-content-wrapper">
            <div class="sidebar">
                <h2 class="section-title"><i class="fas fa-list"></i> Lista de Pessoas</h2>
                <ul class="person-list" id="person-list">
                    <li class="empty-message">
                        <i class="fas fa-spinner fa-spin"></i>
                        <div>A carregar dados...</div>
                    </li>
                </ul>
            </div>
            
            <div class="main-content-area">
                <div class="content-tabs">
                    <button class="tab-btn active" id="tree-tab">
                        <i class="fas fa-project-diagram tab-icon"></i>
                        <span>Árvore</span>
                    </button>
                    <button class="tab-btn" id="details-tab">
                        <i class="fas fa-user tab-icon"></i>
                        <span>Detalhes</span>
                    </button>
                </div>
                
                <div class="tab-content">
                    <div class="tab-pane active" id="tree-pane">
                        <div class="tree-section">
                            <div class="tree-container" id="tree-container">
                                <div class="empty-message">
                                    <i class="fas fa-tree"></i>
                                    <div>Selecione uma pessoa para visualizar a árvore genealógica completa</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane" id="details-pane">
                        <div class="details-section">
                            <div class="details-panel" id="details-panel">
                                <div class="relationship-badge" id="relationship-badge">
                                    Pessoa Selecionada
                                </div>
                                <h2 class="section-title"><i class="fas fa-user"></i> Detalhes da Pessoa</h2>
                                <div class="details-content-wrapper">
                                    <div class="details-grid" id="details-content">
                                        <!-- Detalhes serão preenchidos aqui -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>Árvore Genealógica &copy; 2023 | Mostra relações familiares com graus de parentesco</p>
        </footer>
    </div>

    <script>
        // Dados carregados dos ficheiros
        let places = [];
        let persons = [];
        let marriages = [];
        let relationships = [];
        
        // Mapeamentos para acesso rápido
        let placesMap = {};
        let personsMap = {};
        let marriagesMap = {};
        let childrenMap = {}; // Mapa de família para filhos
        let parentsMap = {}; // Mapa de pessoa para seus pais
        
        // Pessoa selecionada atualmente
        let selectedPerson = null;
        
        // Variáveis para elementos DOM
        let searchInput, personList, treeContainer, detailsPanel, detailsContent;
        let relationshipBadge, searchButton, clearSearchButton;
        let searchResults;
        let treeTab, detailsTab, treePane, detailsPane;
        
        // Função para remover acentos
        function removeAccents(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }
        
        // Função para normalizar texto para busca (remove acentos, converte para minúsculas)
        function normalizeSearchText(text) {
            if (!text) return '';
            return removeAccents(text.toLowerCase());
        }
        
        // Inicializar quando a página carrega
        document.addEventListener('DOMContentLoaded', function() {
            initializeElements();
            initializeEventListeners();
            loadAllFiles();
            showMessage('A carregar dados automaticamente...', 'info');
            
            // Ajustar layout inicial para mobile
            adjustMobileLayout();
        });
        
        // Ajustar layout para mobile
        function adjustMobileLayout() {
            if (window.innerWidth <= 767) {
                // Ajustar altura do sidebar em mobile
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.style.height = '200px';
                }
            }
        }
        
        // Inicializar elementos DOM
        function initializeElements() {
            searchInput = document.getElementById('search-input');
            personList = document.getElementById('person-list');
            treeContainer = document.getElementById('tree-container');
            detailsPanel = document.getElementById('details-panel');
            detailsContent = document.getElementById('details-content');
            relationshipBadge = document.getElementById('relationship-badge');
            searchResults = document.getElementById('search-results');
            searchButton = document.getElementById('search-button');
            clearSearchButton = document.getElementById('clear-search');
            
            // Tab elements
            treeTab = document.getElementById('tree-tab');
            detailsTab = document.getElementById('details-tab');
            treePane = document.getElementById('tree-pane');
            detailsPane = document.getElementById('details-pane');
        }
        
        // Configurar event listeners
        function initializeEventListeners() {
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const hasText = this.value.trim().length > 0;
                    clearSearchButton.classList.toggle('active', hasText);
                    
                    if (this.value.trim().length >= 2) {
                        performSearch();
                    } else {
                        hideSearchResults();
                    }
                });
                
                searchInput.addEventListener('keyup', function(event) {
                    if (event.key === 'Enter') {
                        performSearch();
                    }
                });
                
                // Fechar resultados ao clicar fora
                document.addEventListener('click', function(event) {
                    if (!searchResults.contains(event.target) && 
                        event.target !== searchInput && 
                        event.target !== searchButton && 
                        !searchButton.contains(event.target)) {
                        hideSearchResults();
                    }
                });
                
                // Prevenir comportamento padrão do formulário
                searchInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                    }
                });
            }
            
            if (searchButton) {
                searchButton.addEventListener('click', performSearch);
            }
            
            if (clearSearchButton) {
                clearSearchButton.addEventListener('click', function() {
                    searchInput.value = '';
                    this.classList.remove('active');
                    hideSearchResults();
                    searchInput.focus();
                });
            }
            
            // Tab switching
            if (treeTab) treeTab.addEventListener('click', () => switchTab('tree'));
            if (detailsTab) detailsTab.addEventListener('click', () => switchTab('details'));
            
            // Ajustar layout ao redimensionar
            window.addEventListener('resize', adjustMobileLayout);
        }
        
        // Switch between tabs
        function switchTab(tabName) {
            // Update tab buttons
            treeTab.classList.remove('active');
            detailsTab.classList.remove('active');
            
            // Hide all panes
            treePane.classList.remove('active');
            detailsPane.classList.remove('active');
            
            // Show selected tab
            if (tabName === 'tree') {
                treeTab.classList.add('active');
                treePane.classList.add('active');
            } else if (tabName === 'details') {
                detailsTab.classList.add('active');
                detailsPane.classList.add('active');
            }
        }
        
        // Hide search results
        function hideSearchResults() {
            searchResults.classList.remove('active');
        }
        
        // Perform search and show results
        function performSearch() {
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) {
                hideSearchResults();
                return;
            }
            
            // Normalizar o termo de busca (remover acentos e converter para minúsculas)
            const normalizedSearchTerm = normalizeSearchText(searchTerm);
            
            // Procurar pessoas
            const foundPersons = persons.filter(person => {
                // Normalizar os campos para busca
                const normalizedName = normalizeSearchText(person.nome);
                const normalizedSurname = normalizeSearchText(person.sobrenome);
                const normalizedId = normalizeSearchText(person.id);
                
                // Verificar se o termo de busca corresponde a qualquer campo
                return normalizedName.includes(normalizedSearchTerm) ||
                       normalizedSurname.includes(normalizedSearchTerm) ||
                       normalizedId.includes(normalizedSearchTerm);
            });
            
            if (foundPersons.length > 0) {
                showSearchResults(foundPersons, searchTerm);
            } else {
                showSearchResults([], searchTerm);
            }
            
            // Mostrar resultados automaticamente em mobile
            if (window.innerWidth <= 767) {
                searchResults.classList.add('active');
            }
        }
        
        // Destacar texto nos resultados
        function highlightText(text, searchTerm) {
            if (!searchTerm || !text) return text;
            
            const normalizedText = normalizeSearchText(text);
            const normalizedSearchTerm = normalizeSearchText(searchTerm);
            
            if (!normalizedText.includes(normalizedSearchTerm)) return text;
            
            // Encontrar posição onde o termo começa (considerando acentos)
            let startIndex = 0;
            let found = false;
            
            // Procurar o termo no texto original considerando acentos
            for (let i = 0; i <= text.length - searchTerm.length; i++) {
                const substring = text.substring(i, i + searchTerm.length);
                if (normalizeSearchText(substring) === normalizedSearchTerm) {
                    startIndex = i;
                    found = true;
                    break;
                }
            }
            
            if (!found) return text;
            
            const endIndex = startIndex + searchTerm.length;
            return text.substring(0, startIndex) + 
                   '<span class="highlight">' + text.substring(startIndex, endIndex) + '</span>' + 
                   text.substring(endIndex);
        }
        
        // Show search results in dropdown
        function showSearchResults(results, searchTerm) {
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'no-results';
                noResults.innerHTML = `<i class="fas fa-search"></i><div>Nenhuma pessoa encontrada para "${searchTerm}"</div>`;
                searchResults.appendChild(noResults);
            } else {
                // Adicionar contador de resultados
                const countDiv = document.createElement('div');
                countDiv.className = 'search-count';
                countDiv.textContent = `${results.length} ${results.length === 1 ? 'pessoa encontrada' : 'pessoas encontradas'}`;
                searchResults.appendChild(countDiv);
                
                results.forEach(person => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'search-result-info';
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'search-result-name';
                    nameDiv.innerHTML = highlightText(person.nome || 'Nome desconhecido', searchTerm);
                    
                    const surnameDiv = document.createElement('div');
                    surnameDiv.className = 'search-result-surname';
                    surnameDiv.innerHTML = highlightText(person.sobrenome || '', searchTerm);
                    
                    infoDiv.appendChild(nameDiv);
                    infoDiv.appendChild(surnameDiv);
                    
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'search-result-details';
                    
                    const birthSpan = document.createElement('span');
                    birthSpan.className = 'search-result-birth';
                    birthSpan.textContent = `Nasc: ${extractYear(person.data_nascimento)}`;
                    
                    const idSpan = document.createElement('span');
                    idSpan.className = 'search-result-id';
                    idSpan.textContent = person.id;
                    
                    detailsDiv.appendChild(birthSpan);
                    detailsDiv.appendChild(idSpan);
                    
                    resultItem.appendChild(infoDiv);
                    resultItem.appendChild(detailsDiv);
                    
                    resultItem.addEventListener('click', () => {
                        selectPerson(person.id);
                        searchInput.value = '';
                        clearSearchButton.classList.remove('active');
                        hideSearchResults();
                        
                        // Fechar teclado virtual em mobile após seleção
                        if (window.innerWidth <= 767) {
                            searchInput.blur();
                        }
                    });
                    
                    searchResults.appendChild(resultItem);
                });
            }
            
            searchResults.classList.add('active');
        }
        
        // Carregar todos os ficheiros automaticamente
        async function loadAllFiles() {
            // Atualizar mensagens
            if (personList) personList.innerHTML = '<li class="empty-message"><i class="fas fa-spinner fa-spin"></i><div>A carregar dados...</div></li>';
            if (treeContainer) treeContainer.innerHTML = '<div class="empty-message"><i class="fas fa-tree"></i><div>A carregar dados...</div></div>';
            hideSearchResults();
            
            try {
                // Carregar todos os ficheiros
                const [placesData, personsData, marriagesData, relationshipsData] = await Promise.all([
                    loadFile('places.json'),
                    loadFile('persons.json'),
                    loadFile('marriages.json'),
                    loadFile('relationships.json')
                ]);
                
                // Atualizar dados
                places = placesData;
                persons = personsData;
                marriages = marriagesData;
                relationships = relationshipsData;
                
                // Criar mapeamentos
                createMaps();
                
                // Atualizar interface
                updatePersonList();
                
                showMessage('Dados carregados com sucesso!', 'success');
                
                // Selecionar primeira pessoa
                if (persons.length > 0) {
                    setTimeout(() => selectPerson(persons[0].id), 500);
                }
                
            } catch (error) {
                console.error('Erro ao carregar ficheiros:', error);
                showMessage('Erro ao carregar ficheiros. Verifique os ficheiros JSON.', 'error');
            }
        }
        
        // Carregar ficheiro
        async function loadFile(filename) {
            const response = await fetch(filename);
            if (!response.ok) throw new Error(`${filename} não encontrado`);
            const data = await response.json();
            if (!Array.isArray(data)) throw new Error(`${filename} não é um array válido`);
            return data;
        }
        
        // Criar mapeamentos
        function createMaps() {
            // Mapear lugares
            placesMap = {};
            places.forEach(place => placesMap[place.id] = place);
            
            // Mapear pessoas
            personsMap = {};
            persons.forEach(person => {
                personsMap[person.id] = person;
                if (person.lugar_nascimento && placesMap[person.lugar_nascimento]) {
                    person.lugar_nascimento_nome = placesMap[person.lugar_nascimento].nome;
                }
            });
            
            // Mapear casamentos
            marriagesMap = {};
            marriages.forEach(marriage => marriagesMap[marriage.id] = marriage);
            
            // Mapear filhos por família
            childrenMap = {};
            relationships.forEach(rel => {
                if (!childrenMap[rel.familia]) childrenMap[rel.familia] = [];
                childrenMap[rel.familia].push(rel.filho);
            });
            
            // Mapear pais por pessoa
            parentsMap = {};
            relationships.forEach(rel => {
                const marriage = marriagesMap[rel.familia];
                if (marriage) {
                    parentsMap[rel.filho] = {
                        father: marriage.marido,
                        mother: marriage.esposa
                    };
                }
            });
        }
        
        // Atualizar lista de pessoas
        function updatePersonList() {
            if (!personList) return;
            
            personList.innerHTML = '';
            
            if (persons.length === 0) {
                personList.innerHTML = '<li class="empty-message"><i class="fas fa-users"></i><div>Nenhuma pessoa carregada</div></li>';
                return;
            }
            
            // Ordenar por nome
            const sortedPersons = [...persons].sort((a, b) => {
                const nameA = (a.nome || '').toLowerCase();
                const nameB = (b.nome || '').toLowerCase();
                return nameA.localeCompare(nameB);
            });
            
            // Adicionar à lista
            sortedPersons.forEach(person => {
                const li = document.createElement('li');
                li.className = 'person-item';
                li.dataset.id = person.id;
                
                const nameContainer = document.createElement('div');
                nameContainer.className = 'person-name-container';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'person-name';
                const fullName = person.nome || 'Nome desconhecido';
                if (fullName.length > 20) {
                    nameDiv.textContent = fullName.substring(0, 20) + '...';
                    nameDiv.classList.add('has-tooltip');
                    nameDiv.setAttribute('data-tooltip', fullName);
                } else {
                    nameDiv.textContent = fullName;
                }
                
                const genderDiv = document.createElement('div');
                genderDiv.className = 'person-gender';
                genderDiv.textContent = person.sexo === 'masculino' ? '♂' : person.sexo === 'feminino' ? '♀' : '?';
                
                nameContainer.appendChild(nameDiv);
                nameContainer.appendChild(genderDiv);
                
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'person-details';
                
                const surnameDiv = document.createElement('div');
                surnameDiv.className = 'person-surname';
                const fullSurname = person.sobrenome || '';
                if (fullSurname.length > 25) {
                    surnameDiv.textContent = fullSurname.substring(0, 25) + '...';
                    surnameDiv.classList.add('has-tooltip');
                    surnameDiv.setAttribute('data-tooltip', fullSurname);
                } else {
                    surnameDiv.textContent = fullSurname;
                }
                
                const metaDiv = document.createElement('div');
                metaDiv.className = 'person-meta';
                
                const birthDiv = document.createElement('div');
                birthDiv.className = 'person-birth';
                birthDiv.textContent = `Nasc: ${extractYear(person.data_nascimento)}`;
                
                const idDiv = document.createElement('div');
                idDiv.className = 'person-id';
                idDiv.textContent = person.id;
                
                metaDiv.appendChild(birthDiv);
                metaDiv.appendChild(idDiv);
                
                detailsDiv.appendChild(surnameDiv);
                detailsDiv.appendChild(metaDiv);
                
                li.appendChild(nameContainer);
                li.appendChild(detailsDiv);
                
                li.addEventListener('click', () => selectPerson(person.id));
                
                personList.appendChild(li);
            });
        }
        
        // Extrair ano
        function extractYear(dateString) {
            if (!dateString) return '?';
            const yearMatch = dateString.match(/\b\d{4}\b/);
            return yearMatch ? yearMatch[0] : '?';
        }
        
        // Selecionar pessoa
        function selectPerson(personId) {
            selectedPerson = personsMap[personId];
            
            // Atualizar lista
            document.querySelectorAll('.person-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id === personId) item.classList.add('active');
            });
            
            // Atualizar badge de relação
            if (relationshipBadge) {
                relationshipBadge.textContent = 'Pessoa Selecionada';
                relationshipBadge.style.backgroundColor = '#3498db';
            }
            
            // Gerar árvore
            generateFamilyTree(personId);
            
            // Mostrar detalhes
            showPersonDetails(personId);
            
            // Switch to tree tab by default when selecting a person
            switchTab('tree');
            
            // Scroll para o item selecionado na lista em mobile
            if (window.innerWidth <= 767) {
                const activeItem = document.querySelector(`.person-item[data-id="${personId}"]`);
                if (activeItem) {
                    activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }
        
        // Gerar árvore genealógica
        function generateFamilyTree(personId) {
            if (!treeContainer) return;
            
            treeContainer.innerHTML = '';
            
            const mainPerson = personsMap[personId];
            if (!mainPerson) {
                treeContainer.innerHTML = '<div class="empty-message"><i class="fas fa-user-times"></i><div>Pessoa não encontrada</div></div>';
                return;
            }
            
            // Get layout based on screen size
            const layout = adjustTreeLayoutForScreen();
            const nodeWidth = layout.nodeWidth;
            const nodeHeight = layout.nodeHeight;
            const horizontalSpacing = layout.horizontalSpacing;
            const verticalSpacing = layout.verticalSpacing;
            
            // Coletar pessoas para mostrar
            const allPersons = new Set([personId]);
            const positions = new Map();
            
            // Adicionar pais
            const parents = parentsMap[personId];
            if (parents) {
                if (parents.father) allPersons.add(parents.father);
                if (parents.mother) allPersons.add(parents.mother);
                
                // Adicionar avós paternos
                const paternalGrandparents = parents.father ? parentsMap[parents.father] : null;
                if (paternalGrandparents) {
                    if (paternalGrandparents.father) allPersons.add(paternalGrandparents.father);
                    if (paternalGrandparents.mother) allPersons.add(paternalGrandparents.mother);
                }
                
                // Adicionar avós maternos
                const maternalGrandparents = parents.mother ? parentsMap[parents.mother] : null;
                if (maternalGrandparents) {
                    if (maternalGrandparents.father) allPersons.add(maternalGrandparents.father);
                    if (maternalGrandparents.mother) allPersons.add(maternalGrandparents.mother);
                }
            }
            
            // Adicionar filhos
            const children = findChildren(personId);
            children.forEach(childId => allPersons.add(childId));
            
            // Adicionar cônjuge(s)
            const spouses = findSpouses(personId);
            spouses.forEach(spouseId => allPersons.add(spouseId));
            
            // Organizar por gerações
            const generations = [];
            
            // Geração -2: Bisavós (simplificado)
            const greatGrandparents = [];
            
            // Geração -1: Avós
            const grandparents = [];
            if (parents) {
                const paternalGrandparents = parents.father ? parentsMap[parents.father] : null;
                if (paternalGrandparents) {
                    if (paternalGrandparents.father) grandparents.push(paternalGrandparents.father);
                    if (paternalGrandparents.mother) grandparents.push(paternalGrandparents.mother);
                }
                const maternalGrandparents = parents.mother ? parentsMap[parents.mother] : null;
                if (maternalGrandparents) {
                    if (maternalGrandparents.father) grandparents.push(maternalGrandparents.father);
                    if (maternalGrandparents.mother) grandparents.push(maternalGrandparents.mother);
                }
            }
            
            // Geração 0: Pais
            const parentGeneration = [];
            if (parents) {
                if (parents.father) parentGeneration.push(parents.father);
                if (parents.mother) parentGeneration.push(parents.mother);
            }
            
            // Geração 1: Pessoa principal e cônjuges
            const mainGeneration = [personId];
            spouses.forEach(spouseId => mainGeneration.push(spouseId));
            
            // Geração 2: Filhos
            const childrenGeneration = children;
            
            // Adicionar gerações
            if (greatGrandparents.length > 0) generations.push({depth: -2, persons: greatGrandparents});
            if (grandparents.length > 0) generations.push({depth: -1, persons: grandparents});
            if (parentGeneration.length > 0) generations.push({depth: 0, persons: parentGeneration});
            generations.push({depth: 1, persons: mainGeneration});
            if (childrenGeneration.length > 0) generations.push({depth: 2, persons: childrenGeneration});
            
            // Encontrar geração com mais pessoas
            let maxNodesInRow = 0;
            generations.forEach(gen => {
                if (gen.persons.length > maxNodesInRow) maxNodesInRow = gen.persons.length;
            });
            
            const startX = Math.max(30, (treeContainer.clientWidth - (maxNodesInRow * horizontalSpacing)) / 2);
            
            // Posicionar nós
            generations.forEach((gen, genIndex) => {
                const y = 30 + genIndex * verticalSpacing;
                const genWidth = gen.persons.length * horizontalSpacing;
                const startGenX = startX + (maxNodesInRow * horizontalSpacing - genWidth) / 2;
                
                gen.persons.forEach((personId, index) => {
                    const person = personsMap[personId];
                    if (!person) return;
                    
                    const x = startGenX + index * horizontalSpacing;
                    positions.set(personId, { x, y });
                    
                    // Determinar relação com a pessoa selecionada
                    const relationship = getRelationship(personId, personId === personId ? 'self' : personId);
                    
                    // Criar nó
                    const node = createPersonNode(person, x, y, nodeWidth, nodeHeight, relationship);
                    if (personId === selectedPerson.id) {
                        node.classList.add('selected');
                    }
                    treeContainer.appendChild(node);
                });
            });
            
            // Desenhar conexões entre gerações
            for (let i = 0; i < generations.length - 1; i++) {
                const currentGen = generations[i];
                const nextGen = generations[i + 1];
                
                currentGen.persons.forEach(parentId => {
                    const parent = personsMap[parentId];
                    if (!parent) return;
                    
                    const parentPos = positions.get(parentId);
                    if (!parentPos) return;
                    
                    // Encontrar filhos desta pessoa na próxima geração
                    const childrenIds = findChildren(parentId);
                    
                    childrenIds.forEach(childId => {
                        if (nextGen.persons.includes(childId)) {
                            const childPos = positions.get(childId);
                            if (childPos) {
                                drawConnection(parentPos, childPos, nodeWidth, nodeHeight);
                            }
                        }
                    });
                });
            }
            
            // Desenhar conexões entre cônjuges
            mainGeneration.forEach(personId1 => {
                mainGeneration.forEach(personId2 => {
                    if (personId1 !== personId2 && areSpouses(personId1, personId2)) {
                        const pos1 = positions.get(personId1);
                        const pos2 = positions.get(personId2);
                        if (pos1 && pos2) {
                            drawSpouseConnection(pos1, pos2, nodeWidth);
                        }
                    }
                });
            });
        }
        
        // Adjust tree layout based on screen size
        function adjustTreeLayoutForScreen() {
            const treeContainer = document.getElementById('tree-container');
            if (!treeContainer) {
                return {
                    nodeWidth: 120,
                    nodeHeight: 70,
                    horizontalSpacing: 140,
                    verticalSpacing: 110
                };
            }
            
            const containerHeight = treeContainer.clientHeight;
            const containerWidth = treeContainer.clientWidth;
            
            // Mobile screens
            if (containerWidth < 768) {
                return {
                    nodeWidth: 100,
                    nodeHeight: 60,
                    horizontalSpacing: 110,
                    verticalSpacing: 90
                };
            }
            
            // Medium screens
            if (containerWidth < 1024) {
                return {
                    nodeWidth: 110,
                    nodeHeight: 65,
                    horizontalSpacing: 125,
                    verticalSpacing: 100
                };
            }
            
            // Large screens
            return {
                nodeWidth: 130,
                nodeHeight: 75,
                horizontalSpacing: 150,
                verticalSpacing: 120
            };
        }
        
        // Determinar relação com a pessoa selecionada - versão abreviada
        function getRelationship(personId, relativeToId) {
            if (personId === relativeToId) return 'Eu';
            
            const relativeTo = selectedPerson.id;
            
            // Pai/Mãe
            const parents = parentsMap[relativeTo];
            if (parents && (parents.father === personId || parents.mother === personId)) {
                return parents.father === personId ? 'Pai' : 'Mãe';
            }
            
            // Filhos
            const children = findChildren(relativeTo);
            if (children.includes(personId)) {
                const person = personsMap[personId];
                return person && person.sexo === 'masculino' ? 'Filho' : 'Filha';
            }
            
            // Cônjuge
            if (areSpouses(personId, relativeTo)) {
                const person = personsMap[personId];
                return person && person.sexo === 'masculino' ? 'Marido' : 'Esposa';
            }
            
            // Avós
            if (parents) {
                // Avô paterno
                if (parents.father) {
                    const paternalGrandparents = parentsMap[parents.father];
                    if (paternalGrandparents && (paternalGrandparents.father === personId || paternalGrandparents.mother === personId)) {
                        return paternalGrandparents.father === personId ? 'Avô P.' : 'Avó P.';
                    }
                }
                
                // Avô materno
                if (parents.mother) {
                    const maternalGrandparents = parentsMap[parents.mother];
                    if (maternalGrandparents && (maternalGrandparents.father === personId || maternalGrandparents.mother === personId)) {
                        return maternalGrandparents.father === personId ? 'Avô M.' : 'Avó M.';
                    }
                }
            }
            
            // Netos
            const grandchildren = [];
            children.forEach(childId => {
                const childsChildren = findChildren(childId);
                childsChildren.forEach(grandchildId => grandchildren.push(grandchildId));
            });
            
            if (grandchildren.includes(personId)) {
                const person = personsMap[personId];
                return person && person.sexo === 'masculino' ? 'Neto' : 'Neta';
            }
            
            // Irmãos
            if (parents) {
                const siblings = [];
                if (parents.father || parents.mother) {
                    // Encontrar todos os filhos dos mesmos pais
                    Object.keys(parentsMap).forEach(childId => {
                        const childParents = parentsMap[childId];
                        if (childParents && 
                            ((childParents.father === parents.father && childParents.mother === parents.mother) ||
                             (childParents.father === parents.father && !parents.mother && !childParents.mother) ||
                             (!parents.father && childParents.mother === parents.mother && !childParents.father))) {
                            if (childId !== relativeTo) {
                                siblings.push(childId);
                            }
                        }
                    });
                }
                
                if (siblings.includes(personId)) {
                    const person = personsMap[personId];
                    return person && person.sexo === 'masculino' ? 'Irmão' : 'Irmã';
                }
            }
            
            return 'Parente';
        }
        
        // Desenhar conexão entre pais e filhos
        function drawConnection(parentPos, childPos, nodeWidth, nodeHeight) {
            const line1 = document.createElement('div');
            line1.className = 'tree-line';
            line1.style.left = `${parentPos.x + nodeWidth/2 - 1}px`;
            line1.style.top = `${parentPos.y + nodeHeight}px`;
            line1.style.width = '2px';
            line1.style.height = '15px';
            treeContainer.appendChild(line1);
            
            const line2 = document.createElement('div');
            line2.className = 'tree-line';
            line2.style.left = `${Math.min(parentPos.x + nodeWidth/2, childPos.x + nodeWidth/2)}px`;
            line2.style.top = `${parentPos.y + nodeHeight + 15}px`;
            line2.style.width = `${Math.abs(childPos.x - parentPos.x)}px`;
            line2.style.height = '2px';
            treeContainer.appendChild(line2);
            
            const line3 = document.createElement('div');
            line3.className = 'tree-line';
            line3.style.left = `${childPos.x + nodeWidth/2 - 1}px`;
            line3.style.top = `${parentPos.y + nodeHeight + 15}px`;
            line3.style.width = '2px';
            line3.style.height = `${childPos.y - (parentPos.y + nodeHeight + 15)}px`;
            treeContainer.appendChild(line3);
        }
        
        // Desenhar conexão entre cônjuges
        function drawSpouseConnection(pos1, pos2, nodeWidth) {
            const line = document.createElement('div');
            line.className = 'tree-line';
            line.style.left = `${pos1.x + nodeWidth}px`;
            line.style.top = `${pos1.y + 30}px`;
            line.style.width = `${pos2.x - pos1.x - nodeWidth}px`;
            line.style.height = '2px';
            treeContainer.appendChild(line);
        }
        
        // Encontrar cônjuges de uma pessoa
        function findSpouses(personId) {
            const spouses = [];
            marriages.forEach(marriage => {
                if (marriage.marido === personId && marriage.esposa) {
                    spouses.push(marriage.esposa);
                } else if (marriage.esposa === personId && marriage.marido) {
                    spouses.push(marriage.marido);
                }
            });
            return spouses;
        }
        
        // Verificar se duas pessoas são cônjuges
        function areSpouses(personId1, personId2) {
            return marriages.some(marriage => 
                (marriage.marido === personId1 && marriage.esposa === personId2) ||
                (marriage.marido === personId2 && marriage.esposa === personId1)
            );
        }
        
        // Encontrar filhos diretos
        function findChildren(personId) {
            const children = [];
            
            // Encontrar casamentos desta pessoa
            const personMarriages = marriages.filter(marriage => 
                marriage.marido === personId || marriage.esposa === personId
            );
            
            personMarriages.forEach(marriage => {
                const marriageChildren = childrenMap[marriage.id] || [];
                marriageChildren.forEach(childId => {
                    if (!children.includes(childId)) {
                        children.push(childId);
                    }
                });
            });
            
            return children;
        }
        
        // Criar nó da árvore
        function createPersonNode(person, x, y, width = 130, height = 75, relationship = '') {
            const node = document.createElement('div');
            node.className = `tree-node ${person.sexo || 'unknown'}`;
            node.style.left = `${x}px`;
            node.style.top = `${y}px`;
            node.style.width = `${width}px`;
            node.style.height = `${height}px`;
            node.dataset.id = person.id;
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'node-name';
            const fullName = person.nome || 'Nome desconhecido';
            if (fullName.length > 15) {
                nameDiv.textContent = fullName.substring(0, 15) + '...';
                nameDiv.classList.add('has-tooltip');
                nameDiv.setAttribute('data-tooltip', fullName);
            } else {
                nameDiv.textContent = fullName;
            }
            
            const surnameDiv = document.createElement('div');
            surnameDiv.className = 'node-surname';
            const fullSurname = person.sobrenome || '';
            if (fullSurname.length > 18) {
                surnameDiv.textContent = fullSurname.substring(0, 18) + '...';
                surnameDiv.classList.add('has-tooltip');
                surnameDiv.setAttribute('data-tooltip', fullSurname);
            } else {
                surnameDiv.textContent = fullSurname;
            }
            
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'node-details';
            
            const birthYear = extractYear(person.data_nascimento);
            const deathYear = extractYear(person.data_falecimento);
            
            let detailsText = `${birthYear}`;
            if (deathYear && deathYear !== '?') detailsText += ` - ${deathYear}`;
            
            detailsDiv.textContent = detailsText;
            
            const relationshipDiv = document.createElement('div');
            relationshipDiv.className = 'node-relationship';
            relationshipDiv.textContent = relationship;
            
            node.appendChild(nameDiv);
            node.appendChild(surnameDiv);
            node.appendChild(detailsDiv);
            node.appendChild(relationshipDiv);
            
            node.addEventListener('click', (e) => {
                e.stopPropagation();
                selectPerson(person.id);
            });
            
            return node;
        }
        
        // Mostrar detalhes da pessoa
        function showPersonDetails(personId) {
            const person = personsMap[personId];
            if (!person || !detailsContent) return;
            
            detailsPanel.classList.add('active');
            detailsContent.innerHTML = '';
            
            // Informações básicas
            addDetailItem('fas fa-user', 'Nome Completo', person.nome || 'Desconhecido');
            addDetailItem('fas fa-tag', 'Sobrenome', person.sobrenome || 'Não registado');
            addDetailItem('fas fa-venus-mars', 'Sexo', person.sexo === 'masculino' ? 'Masculino (♂)' : 
                         person.sexo === 'feminino' ? 'Feminino (♀)' : 'Desconhecido');
            addDetailItem('fas fa-id-card', 'ID', person.id);
            
            // Nascimento
            if (person.data_nascimento) {
                addDetailItem('fas fa-birthday-cake', 'Data de Nascimento', formatDate(person.data_nascimento));
            }
            if (person.lugar_nascimento_nome) {
                addDetailItem('fas fa-map-marker-alt', 'Local de Nascimento', person.lugar_nascimento_nome);
            } else if (person.lugar_nascimento) {
                addDetailItem('fas fa-map-marker-alt', 'Local de Nascimento', `ID: ${person.lugar_nascimento}`);
            }
            
            // Batismo
            if (person.data_batismo) {
                addDetailItem('fas fa-water', 'Data de Batismo', formatDate(person.data_batismo));
            }
            if (person.lugar_batismo && placesMap[person.lugar_batismo]) {
                addDetailItem('fas fa-map-marker-alt', 'Local de Batismo', placesMap[person.lugar_batismo].nome);
            }
            
            // Falecimento
            if (person.data_falecimento) {
                addDetailItem('fas fa-cross', 'Data de Falecimento', formatDate(person.data_falecimento));
            }
            if (person.lugar_falecimento && placesMap[person.lugar_falecimento]) {
                addDetailItem('fas fa-map-marker-alt', 'Local de Falecimento', placesMap[person.lugar_falecimento].nome);
            }
            
            // Pais
            const parents = parentsMap[personId];
            if (parents) {
                const parentsList = document.createElement('ul');
                parentsList.className = 'relationship-list';
                
                if (parents.father && personsMap[parents.father]) {
                    const father = personsMap[parents.father];
                    const li = createRelationshipItem(father, 'Pai');
                    parentsList.appendChild(li);
                }
                
                if (parents.mother && personsMap[parents.mother]) {
                    const mother = personsMap[parents.mother];
                    const li = createRelationshipItem(mother, 'Mãe');
                    parentsList.appendChild(li);
                }
                
                addDetailItemWithContent('fas fa-users', 'Pais', parentsList);
            }
            
            // Cônjuges
            const spouses = findSpouses(personId);
            if (spouses.length > 0) {
                const spousesList = document.createElement('ul');
                spousesList.className = 'relationship-list';
                
                spouses.forEach(spouseId => {
                    const spouse = personsMap[spouseId];
                    if (spouse) {
                        const relationshipType = spouse.sexo === 'masculino' ? 'Marido' : 'Esposa';
                        const li = createRelationshipItem(spouse, relationshipType);
                        spousesList.appendChild(li);
                    }
                });
                
                addDetailItemWithContent('fas fa-ring', 'Cônjuges', spousesList);
            }
            
            // Filhos
            const children = findChildren(personId);
            if (children.length > 0) {
                const childrenList = document.createElement('ul');
                childrenList.className = 'relationship-list';
                
                children.forEach(childId => {
                    const child = personsMap[childId];
                    if (child) {
                        const relationshipType = child.sexo === 'masculino' ? 'Filho' : 'Filha';
                        const li = createRelationshipItem(child, relationshipType);
                        childrenList.appendChild(li);
                    }
                });
                
                addDetailItemWithContent('fas fa-baby', 'Filhos', childrenList);
            }
        }
        
        // Criar item de relação
        function createRelationshipItem(person, relationshipType) {
            const li = document.createElement('li');
            li.className = 'relationship-item';
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'relationship-info';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'relationship-name';
            nameDiv.textContent = person.nome || 'Desconhecido';
            
            const typeDiv = document.createElement('div');
            typeDiv.className = 'relationship-type';
            typeDiv.textContent = relationshipType;
            
            infoDiv.appendChild(nameDiv);
            infoDiv.appendChild(typeDiv);
            
            const idDiv = document.createElement('div');
            idDiv.className = 'relationship-id';
            idDiv.textContent = person.id;
            
            li.appendChild(infoDiv);
            li.appendChild(idDiv);
            
            li.addEventListener('click', () => selectPerson(person.id));
            
            return li;
        }
        
        // Adicionar item de detalhe
        function addDetailItem(iconClass, label, value) {
            if (!detailsContent) return;
            
            const item = document.createElement('div');
            item.className = 'detail-item';
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'detail-label';
            
            const icon = document.createElement('i');
            icon.className = iconClass;
            
            const labelText = document.createElement('span');
            labelText.textContent = label;
            
            labelDiv.appendChild(icon);
            labelDiv.appendChild(labelText);
            
            const valueDiv = document.createElement('div');
            valueDiv.className = 'detail-value';
            valueDiv.textContent = value;
            
            item.appendChild(labelDiv);
            item.appendChild(valueDiv);
            detailsContent.appendChild(item);
        }
        
        // Adicionar item de detalhe com conteúdo HTML
        function addDetailItemWithContent(iconClass, label, content) {
            if (!detailsContent) return;
            
            const item = document.createElement('div');
            item.className = 'detail-item';
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'detail-label';
            
            const icon = document.createElement('i');
            icon.className = iconClass;
            
            const labelText = document.createElement('span');
            labelText.textContent = label;
            
            labelDiv.appendChild(icon);
            labelDiv.appendChild(labelText);
            
            const valueDiv = document.createElement('div');
            valueDiv.className = 'detail-value';
            valueDiv.appendChild(content);
            
            item.appendChild(labelDiv);
            item.appendChild(valueDiv);
            detailsContent.appendChild(item);
        }
        
        // Formatar data
        function formatDate(dateString) {
            if (!dateString) return 'Desconhecida';
            
            try {
                const months = {
                    'Jan': 0, 'Fev': 1, 'Mar': 2, 'Abr': 3, 'Mai': 4, 'Jun': 5,
                    'Jul': 6, 'Ago': 7, 'Set': 8, 'Out': 9, 'Nov': 10, 'Dez': 11
                };
                
                const parts = dateString.split(' ');
                if (parts.length >= 3) {
                    const day = parseInt(parts[0]);
                    const month = months[parts[1]];
                    const year = parseInt(parts[2]);
                    
                    if (!isNaN(day) && month !== undefined && !isNaN(year)) {
                        const date = new Date(year, month, day);
                        return date.toLocaleDateString('pt-PT');
                    }
                }
            } catch (e) {}
            
            return dateString;
        }
        
        // Mostrar mensagem
        function showMessage(message, type) {
            const existing = document.querySelectorAll('.status-message-toast');
            existing.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message-toast ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 16px;
                border-radius: 4px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: fadeIn 0.3s ease-in;
                font-size: 0.85rem;
            `;
            
            if (type === 'success') messageDiv.style.backgroundColor = '#27ae60';
            else if (type === 'error') messageDiv.style.backgroundColor = '#e74c3c';
            else messageDiv.style.backgroundColor = '#3498db';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => messageDiv.remove(), 3000);
        }
    </script>
</body>
</html>
